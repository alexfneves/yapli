<!DOCTYPE html>
<html>
<head>

  <meta charset="UTF-8">
  <title>ABCD Inja WASM Demo</title>

  <script>
  (function () {
    const socket = new WebSocket("ws://127.0.0.1:1234");
    socket.onopen = () => console.log("âœ… Connected to reload server");
    socket.onmessage = (msg) => {
      console.log("ðŸ“¨ Received reload:", msg.data);
      location.reload();
    };
  })();
  </script>
  
  <style>
    .container {
      position: relative;
      width: 600px;
      font-family: sans-serif;
    }

    .highlight-layer,
    .input-layer {
      white-space: pre-wrap;
      word-wrap: break-word;
      padding: 10px;
      border: 1px solid #ccc;
      min-height: 100px;
      font-size: 16px;
      line-height: 1.5;
    }

    .highlight-layer {
      position: absolute;
      top: 0;
      left: 0;
      color: transparent;
      pointer-events: none;
      z-index: 1;
    }

    .highlight-layer .word {
      background-color: yellow;
      color: black;
    }

    .highlight-layer .phrase {
      background-color: lightblue;
      color: black;
    }

    .input-layer {
      position: relative;
      background: transparent;
      color: black;
      z-index: 2;
      caret-color: black;
    }

    .input-layer:focus {
      outline: none;
    }
  </style>
</head>
<body>
  <div id="asdf">Loading...</div>
  <div id="fdsa">Loading...</div>


  <!-- <script src="out.js"></script> -->
  <script>
    const context = {
      name: "Alice",
      color: "blue"
    };
    
    (async function () {
      // Load out.js with cache-busting query
      await new Promise((resolve, reject) => {
        const script = document.createElement("script");
        script.src = `out.js?v=${Math.random()}`;
        script.onload = resolve;
        script.onerror = reject;
        document.body.appendChild(script);
      });

      createModule().then((Module) => {
        const render = Module.cwrap('render', 'string', ['string', 'string']);
        let result = render("asdf", JSON.stringify(context));
        document.getElementById("asdf").innerHTML = result;
        <!-- result = render("fdsa", JSON.stringify(context)); -->
        <!-- document.getElementById("fdsa").innerHTML = result; -->
      
        result = render("fdsa", JSON.stringify(context));
        const container = document.getElementById("fdsa");
        container.innerHTML = result;

        // âœ… Re-run <script> blocks from injected HTML
        const scripts = container.querySelectorAll("script");
        scripts.forEach(oldScript => {
          const newScript = document.createElement("script");
          newScript.text = oldScript.textContent;
          document.head.appendChild(newScript);
          oldScript.remove();
        });
      });
    })();
  </script>
  <!-- <script> -->
    <!-- let lastVersion = null; -->

    <!-- async function checkForReload() { -->
      <!-- try { -->
        <!-- const res = await fetch("reload.txt", { cache: "no-store" }); -->
        <!-- const text = await res.text(); -->

        <!-- if (lastVersion && text.trim() !== lastVersion) { -->
          <!-- console.log("Change detected, reloading..."); -->
          <!-- location.reload(true); -->
        <!-- } -->

        <!-- lastVersion = text.trim(); -->
      <!-- } catch (err) { -->
        <!-- console.error("Reload check failed", err); -->
      <!-- } -->

      <!-- setTimeout(checkForReload, 1000); // check every second -->
    <!-- } -->

    <!-- checkForReload(); -->
  <!-- </script> -->

</body>
</html>
