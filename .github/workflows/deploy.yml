name: Build and Deploy GitHub Pages

on:
  push:
    branches:
      - master

jobs:
  build-and-deploy:
    # build:
    runs-on: ubuntu-latest

    container:
      image: nixos/nix # Nix inside container

    steps:
      # - name: Install basic dependencies
      #   run: |
      #     # nix-env --install --attr devenv -f https://github.com/NixOS/nixpkgs/tarball/nixpkgs-unstable
      #     nix-env --install devenv
      #     # nix-env --install devenv nodejs

      # - name: Checkout repo
      #   uses: actions/checkout@v4
      - name: Manually checkout repository
        run: |
          git config --global --add safe.directory /__w/${{ github.event.repository.name }}/${{ github.event.repository.name }}
          git clone https://github.com/${GITHUB_REPOSITORY}.git .
          git checkout $GITHUB_SHA

      # - name: Build site
      #   run: |
      #     # nix develop --no-pure-eval --accept-flake-config -c build
      #     nix --extra-experimental-features flakes --extra-experimental-features nix-command develop --no-pure-eval --accept-flake-config -c build

      # - name: Deploy to GitHub Pages
      #   uses: peaceiris/actions-gh-pages@v3
      #   with:
      #     github_token: ${{ secrets.GITHUB_TOKEN }}
      #     publish_dir: ./public

      - name: Deploy manually to GitHub Pages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git clone https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git gh-pages
          cd gh-pages
          git checkout gh-pages || git checkout -b gh-pages origin/gh-pages
          rm -rf .[^.]*
          cp -r ../public/* .
          touch .nojekyll
          git add .
          git commit -m "Deploy from ${GITHUB_SHA}" || echo "Nothing to commit"
          echo "Currently on branch: $(git symbolic-ref --short HEAD)"
          git push origin gh-pages --force

  #     - name: Upload static files as artifact
  #       id: deployment
  #       uses: actions/upload-pages-artifact@v3 # or specific "vX.X.X" version tag for this action
  #       with:
  #         path: public/

  # # Deployment job
  # deploy:
  #   environment:
  #     name: github-pages
  #     url: ${{ steps.deployment.outputs.page_url }}
  #   runs-on: ubuntu-latest
  #   needs: build
  #   steps:
  #     - name: Deploy to GitHub Pages
  #       id: deployment
  #       uses: actions/deploy-pages@v4
