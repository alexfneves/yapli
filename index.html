<!doctype html>
<html>
  <head>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="/manifest.json" />
    <meta id="head" />
  </head>
  <body>
    <div id="main" class="flex flex-col h-screen overflow-hidden">
      Loading...
    </div>
    <script src="out.js"></script>
    <script>
      (function () {
        const socket = new WebSocket("ws://127.0.0.1:1234");
        socket.onopen = () => console.log("âœ… Connected to reload server");
        socket.onmessage = (msg) => {
          console.log("ðŸ“¨ Received reload:", msg.data);
          location.reload();
        };
      })();
      const context = {
        name: "Alice",
        color: "blue",
      };

      function rerunHeadScripts() {
        const elements = document.head.querySelectorAll("script");
        let newScripts = [];
        elements.forEach((oldElement) => {
          const newElement = oldElement;
          newScripts.push(newElement);
          oldElement.remove();
        });
        newScripts.forEach((newScript) => {
          document.head.appendChild(newScript);
        });
      }

      function rerunScripts(container) {
        const elements = container.querySelectorAll("script");

        elements.forEach((oldElement) => {
          const newElement = document.createElement("script");
          for (let attr of oldElement.attributes) {
            newElement.setAttribute(attr.name, attr.value);
          }
          if (!oldElement.src) {
            newElement.textContent = oldElement.textContent;
          }
          container.appendChild(newElement);
          oldElement.remove();
        });
      }

      (async function () {
        createModule().then((Module) => {
          const render = Module.cwrap("render", "string", ["string", "string"]);
          let result = render("head", JSON.stringify(context));
          let container = document.getElementById("head");
          container.innerHTML = result;
          rerunScripts(container);
          result = render("body", JSON.stringify(context));
          container = document.getElementById("main");
          container.innerHTML = result;
          rerunScripts(container);
        });
      })();

      function setAppHeight() {
        const doc = document.documentElement;
        doc.style.setProperty("--app-height", `${window.innerHeight}px`);
      }

      window.addEventListener("resize", setAppHeight);
      window.addEventListener("orientationchange", setAppHeight);
      setAppHeight();

      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker.register("/sw.js").then((reg) => {
            console.log("SW registered!", reg);
          });
        });
      }
    </script>
  </body>
</html>
